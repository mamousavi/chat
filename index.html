<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat</title>
    <link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
    <link rel="stylesheet" href="https://unpkg.com/concrete.css@2.0.3/concrete.css">
  </head>
  <body>
    <main x-data="app">
      <h1>Chat</h1>
      <section>
        <p x-show="!messages.length">No messages.</p>
        <template x-for="message in messages">
          <p>
            <span x-text="message.role === 'user' ? 'You' : 'Model'"></span>:
            <span x-text="message.content"></span>
          </p>
        </template>
        <form @submit.prevent="generate">
          <input x-model="prompt" type="text" placeholder="Enter prompt..." />
        </form>
        <div x-show="total && !ready">
          <label for="files">
            Downloading model...
            (<span x-text="loadedStr"></span>/<span x-text="totalStr"></span>)
          </label>
          <progress :value="progress" max="100" id="files"></progress>
        </div>
      </section>
    </main>
    <script type="module">
      import * as Comlink from 'https://unpkg.com/comlink/dist/esm/comlink.mjs';

      const worker = Comlink.wrap(new Worker('worker.js', { type: 'module' }));

      document.addEventListener('alpine:init', () => {
        Alpine.data('app', () => ({
          messages: [],
          prompt: '',
          files: {},
          ready: false,
          get loaded() {
            return sum(pluck(Object.values(this.files), 'loaded'));
          },
          get loadedStr() {
            return formatBytes(this.loaded);
          },
          get total() {
            return sum(pluck(Object.values(this.files), 'total'));
          },
          get totalStr() {
            return formatBytes(this.total);
          },
          get progress() {
            return !this.total ? 0 : (this.loaded / this.total) * 100;
          },
          async generate() {
            this.messages.push({ role: 'user', content: this.prompt });
            this.prompt = '';

            if (!this.ready) {
              await worker.init(
                'Xenova/Qwen1.5-0.5B-Chat',
                Comlink.proxy(({ status, file, loaded, total }) => {
                  if (status === 'progress') this.files[file] = { loaded, total };
                  if (status === 'ready') this.ready = true;
                }),
              );
            }

            const messages = [
              { role: 'system', content: 'You are a helpful assistant.' },
              ...Alpine.raw(this.messages),
            ];

            await worker.exec(
              messages,
              Comlink.proxy((output) => {
                if (this.messages.at(-1).role === 'user') this.messages.push({ role: 'assistant', content: output });
                else this.messages.at(-1).content = output;
              }),
            );
          },
        }));
      });

      const pluck = (arr, key) => arr.map((obj) => obj[key]);
      const sum = (arr) => arr.reduce((acc, val) => acc + val, 0);
      const formatBytes = (number) =>
        number.toLocaleString('en', {
          style: 'unit',
          unit: 'byte',
          unitDisplay: 'narrow',
          notation: 'compact',
        });
    </script>
    <script src="//unpkg.com/alpinejs" defer></script>
  </body>
</html>
